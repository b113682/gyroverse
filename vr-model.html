<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>3Dモデル VR体験 - デバッグ版</title>
    <meta name="description" content="ステレオスコピックVR体験">
    <!-- A-Frameライブラリの読み込み -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script>
        // デバッグ情報表示用
        var debugInfo = {
            position: '',
            direction: '',
            moving: false,
            vrMode: false
        };

        function updateDebugDisplay() {
            var debugEl = document.getElementById('debug');
            if (debugEl) {
                debugEl.innerHTML = 
                    '位置: ' + debugInfo.position + '<br>' +
                    '方向: ' + debugInfo.direction + '<br>' +
                    '移動中: ' + debugInfo.moving + '<br>' +
                    'VRモード: ' + debugInfo.vrMode;
            }
        }

        // タッチで前進するコンポーネント（修正版）
        AFRAME.registerComponent('touch-to-move', {
            schema: {
                speed: {default: 0.1}
            },
            init: function() {
                this.moving = false;
                this.touchCount = 0;
                
                this.touchStartHandler = this.onTouchStart.bind(this);
                this.touchEndHandler = this.onTouchEnd.bind(this);
                
                window.addEventListener('touchstart', this.touchStartHandler);
                window.addEventListener('touchend', this.touchEndHandler);
            },
            onTouchStart: function(evt) {
                this.touchCount = evt.touches.length;
                if (evt.touches.length === 1) {
                    this.moving = true;
                    debugInfo.moving = true;
                }
            },
            onTouchEnd: function(evt) {
                this.touchCount = evt.touches.length;
                if (evt.touches.length === 0) {
                    this.moving = false;
                    debugInfo.moving = false;
                }
            },
            tick: function() {
                if (this.moving && this.touchCount === 1) {
                    var rig = this.el;
                    var camera = rig.querySelector('a-camera');
                    if (!camera) return;
                    
                    // カメラの回転から方向を取得
                    var rotation = camera.getAttribute('rotation');
                    var yaw = THREE.MathUtils.degToRad(rotation.y);
                    
                    // Y軸回転のみを使用して水平方向を計算
                    var direction = new THREE.Vector3(
                        -Math.sin(yaw),
                        0,
                        -Math.cos(yaw)
                    );
                    
                    debugInfo.direction = 'x:' + direction.x.toFixed(2) + ' z:' + direction.z.toFixed(2);
                    
                    var position = rig.getAttribute('position');
                    position.x += direction.x * this.data.speed;
                    position.z += direction.z * this.data.speed;
                    rig.setAttribute('position', position);
                    
                    debugInfo.position = 'x:' + position.x.toFixed(2) + ' y:' + position.y.toFixed(2) + ' z:' + position.z.toFixed(2);
                    updateDebugDisplay();
                }
            },
            remove: function() {
                window.removeEventListener('touchstart', this.touchStartHandler);
                window.removeEventListener('touchend', this.touchEndHandler);
            }
        });

        // ピンチでズームするコンポーネント
        AFRAME.registerComponent('pinch-zoom', {
            init: function() {
                this.initialDistance = 0;
                this.currentFov = 80;
                
                this.touchStartHandler = this.onTouchStart.bind(this);
                this.touchMoveHandler = this.onTouchMove.bind(this);
                
                window.addEventListener('touchstart', this.touchStartHandler);
                window.addEventListener('touchmove', this.touchMoveHandler);
            },
            onTouchStart: function(evt) {
                if (evt.touches.length === 2) {
                    evt.preventDefault();
                    var dx = evt.touches[0].pageX - evt.touches[1].pageX;
                    var dy = evt.touches[0].pageY - evt.touches[1].pageY;
                    this.initialDistance = Math.sqrt(dx * dx + dy * dy);
                }
            },
            onTouchMove: function(evt) {
                if (evt.touches.length === 2) {
                    evt.preventDefault();
                    
                    var dx = evt.touches[0].pageX - evt.touches[1].pageX;
                    var dy = evt.touches[0].pageY - evt.touches[1].pageY;
                    var distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (this.initialDistance > 0) {
                        var ratio = distance / this.initialDistance;
                        var newFov = this.currentFov / ratio;
                        newFov = Math.max(30, Math.min(100, newFov));
                        
                        var camera = this.el.querySelector('a-camera');
                        if (camera) {
                            camera.setAttribute('camera', 'fov', newFov);
                        }
                    }
                    
                    this.initialDistance = distance;
                    var camera = this.el.querySelector('a-camera');
                    if (camera) {
                        this.currentFov = camera.getAttribute('camera').fov;
                    }
                }
            },
            remove: function() {
                window.removeEventListener('touchstart', this.touchStartHandler);
                window.removeEventListener('touchmove', this.touchMoveHandler);
            }
        });

        // VRモードで視線方向に自動移動（修正版）
        AFRAME.registerComponent('gaze-move-vr', {
            schema: {
                speed: {default: 0.05}
            },
            init: function() {
                var self = this;
                this.vrEnabled = false;
                
                this.el.sceneEl.addEventListener('enter-vr', function() {
                    self.vrEnabled = true;
                    debugInfo.vrMode = true;
                    console.log('VRモード開始');
                });
                
                this.el.sceneEl.addEventListener('exit-vr', function() {
                    self.vrEnabled = false;
                    debugInfo.vrMode = false;
                    console.log('VRモード終了');
                });
            },
            tick: function() {
                if (!this.vrEnabled) return;
                
                var rig = this.el;
                var camera = rig.querySelector('a-camera');
                if (!camera) return;
                
                // カメラの回転から方向を取得
                var rotation = camera.getAttribute('rotation');
                var yaw = THREE.MathUtils.degToRad(rotation.y);
                
                // Y軸回転のみを使用して水平方向を計算
                var direction = new THREE.Vector3(
                    -Math.sin(yaw),
                    0,
                    -Math.cos(yaw)
                );
                
                var position = rig.getAttribute('position');
                position.x += direction.x * this.data.speed;
                position.z += direction.z * this.data.speed;
                rig.setAttribute('position', position);
                
                debugInfo.position = 'x:' + position.x.toFixed(2) + ' y:' + position.y.toFixed(2) + ' z:' + position.z.toFixed(2);
                debugInfo.direction = 'x:' + direction.x.toFixed(2) + ' z:' + direction.z.toFixed(2);
                updateDebugDisplay();
            }
        });
    </script>
    <style>
        body { margin: 0; overflow: hidden; }
        #instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 1000;
        }
        #debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- 操作説明 -->
    <div id="instructions">
        📱 操作方法:<br>
        • 1本指タッチ(長押し): 前進<br>
        • スワイプ: 視点移動<br>
        • 2本指ピンチ: ズーム<br>
        • VRモード: 見た方向に自動移動
    </div>

    <!-- デバッグ情報 -->
    <div id="debug">
        デバッグ情報を読み込み中...
    </div>

    <!-- VRシーンの定義 -->
    <a-scene vr-mode-ui="enabled: true">
        <!-- カメラリグ（移動可能なカメラコンテナ） -->
        <a-entity id="rig" 
                  touch-to-move="speed: 0.1"
                  pinch-zoom
                  gaze-move-vr="speed: 0.05"
                  position="0 1.6 3">
            <!-- カメラ（視点） -->
            <a-camera look-controls="pointerLockEnabled: false"
                      fov="80">
                <!-- カーソル（視線操作用） -->
                <a-cursor></a-cursor>
            </a-camera>
        </a-entity>

        <!-- 3Dモデルの配置 -->
        <a-entity 
            id="row2"
            gltf-model="url(LS-t_hy.glb)" 
            position="1 1.6 -2"
            scale="2 2 2"
            rotation="0 0 0">
        </a-entity>
        <a-entity 
            id="ro3"
            gltf-model="url(LS-t_MAI.glb)" 
            position="0 0.8 -2"
            scale="2 2 2"
            rotation="0 0 0">
        </a-entity>

        
        <!-- 環境光（全体を照らす光） -->
        <a-light type="ambient" color="#BBB"></a-light>
        
        <!-- 指向性ライト（特定方向からの光） -->
        <a-light type="directional" color="#FFF" intensity="0.6" position="-0.5 1 1"></a-light>
        
        <!-- 空（背景） -->
        <a-sky color="#ECECEC"></a-sky>

        <!-- 地面（参考用） -->
        <a-plane position="0 0 0" 
                 rotation="-90 0 0" 
                 width="10" 
                 height="10" 
                 color="#7BC8A4">
        </a-plane>
        
    </a-scene>
</body>
</html>